name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=driftlab --cov-report=xml || true
    
    - name: Generate demo data
      run: |
        python -m driftlab.cli generate --output-dir data --n-samples 500
    
    - name: Run demo drift job
      run: |
        python -m driftlab.run --ref data/reference/ref.csv --cur data/current/cur.csv --out reports/ci_test/
    
    - name: Check for unexpected alerts
      run: |
        if [ -f reports/ci_test/drift_summary.json ]; then
          python -c "
          import json
          with open('reports/ci_test/drift_summary.json') as f:
            data = json.load(f)
          alerts = data.get('alerts', [])
          critical_alerts = [a for a in alerts if a.get('severity') == 'critical']
          if critical_alerts:
            print('Expected alerts detected (this is OK for demo data with drift)')
            for alert in critical_alerts:
              print(f\"  - {alert.get('message')}\")
          else:
            print('No critical alerts (this is OK)')
          "
        else
          echo "Report not generated - this is a failure"
          exit 1
        fi
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

